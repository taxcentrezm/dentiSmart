<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartDent ERP — HR</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    .card { @apply bg-white rounded-2xl shadow p-4; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>


</head>
<body class="bg-gray-50 font-sans text-gray-800 antialiased">

  <!-- Header -->
  <header class="bg-green-600 text-white py-4 shadow">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-white/90 flex items-center justify-center shadow">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3v6"></path><path d="M8 10s1 2 4 2 4-2 4-2"></path><path d="M6 21s2-4 6-4 6 4 6 4"></path>
          </svg>
        </div>
        <div class="font-semibold text-lg">SmartDent ERP</div>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="openStaffModal()" class="bg-white/90 text-green-600 px-3 py-2 rounded-md inline-flex items-center gap-2 shadow-sm">
  <i data-feather="user-plus"></i> Add Staff
</button>
        <div class="relative">
          <button class="flex items-center gap-2 bg-white/90 px-3 py-2 rounded-full shadow-sm">
            <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=100&auto=format&fit=crop" class="w-8 h-8 rounded-full object-cover">
            <span class="hidden md:inline-block text-sm">Dr. Phiri</span>
            <i data-feather="chevron-down"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
 <main class="container mx-auto px-4 py-6 space-y-6">
  <!-- Staff Directory -->
  <div class="card">
    <h2 class="text-xl font-semibold mb-4">Staff Directory</h2>
    <ul id="staffList" class="divide-y"></ul>
  </div>

  <!-- Payroll & Leave -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Payroll Summary -->
    <div class="card">
      <h3 class="font-semibold mb-3">Payroll Summary</h3>
      <ul id="payrollSummary" class="space-y-2 text-sm"></ul>
      <div class="mt-4 flex gap-2">
        <button onclick="runPayroll()" class="flex-1 px-4 py-2 rounded-md bg-green-600 text-white">Run Payroll</button>
        <button onclick="exportPayroll()" class="px-4 py-2 rounded-md border">Export</button>
      </div>
      <div class="card">
  <h3 class="font-semibold mb-3">Payroll History Chart</h3>
  <canvas id="payrollChart" height="200"></canvas>
</div>
    </div>
    

    <!-- Leave Tracker -->
    <div class="card">
      <h3 class="font-semibold mb-3">Leave Tracker</h3>
      <ul id="leaveTracker" class="space-y-2 text-sm"></ul>
      <br/>
      <br/>
  <canvas id="leaveChart" height="200" ></canvas>
      <div id="leaveKey" class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-2 text-gray-700"></div>
</div>
  </div>
   


  <!-- Add Staff Modal -->
  <div id="staffModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
      <h3 class="text-lg font-semibold mb-4">Add New Staff</h3>
      <div class="space-y-3">
        <input id="staffName" type="text" placeholder="Full Name" class="w-full px-3 py-2 border rounded-md" />
        <input id="staffRole" type="text" placeholder="Role" class="w-full px-3 py-2 border rounded-md" />
        <input id="staffSalary" type="number" placeholder="Salary" class="w-full px-3 py-2 border rounded-md" />
        <input id="staffPhoto" type="text" placeholder="Photo URL" class="w-full px-3 py-2 border rounded-md" />
        <input id="staffDept" type="text" placeholder="Department" class="w-full px-3 py-2 border rounded-md" />
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button onclick="closeStaffModal()" class="px-4 py-2 border rounded-md">Cancel</button>
        <button onclick="addStaff()" class="px-4 py-2 bg-green-600 text-white rounded-md">Add</button>
      </div>
    </div>
  </div>
</main>

  <footer class="mt-8 text-sm text-gray-500 text-center">
    SmartDent ERP • Human Resources & Payroll
  </footer>
  <script src="core.js"></script>
  <!-- Scripts -->
<script>
  feather.replace();
let payrollChartInstance = null;
  let staff = [];

  // ============================
  // LOAD / SAVE STAFF DATA
  // ============================
  function loadStaff() {
    const stored = localStorage.getItem("smartdent_staff");
    staff = stored
      ? JSON.parse(stored)
      : [
          {
            name: "Dr. Alice Mwansa",
            role: "Dentist",
            salary: 5000,
            photo: "female (2).jpg",
            department: "Dental",
            leave: 2,
            payroll: Array.from({ length: 12 }, (_, i) => ({
              month: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][i],
              net: 4400,
            })),
          },
          {
            name: "Dr. Brian Zulu",
            role: "Orthodontist",
            salary: 6200,
            photo: "male (2).jpg",
            department: "Ortho",
            leave: 1,
            payroll: Array.from({ length: 12 }, (_, i) => ({
              month: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][i],
              net: 5456,
            })),
          },
          {
            name: "Nurse Chipo",
            role: "Dental Nurse",
            salary: 1200,
            photo: "female (1).jpg",
            department: "Support",
            leave: 1,
            payroll: Array.from({ length: 12 }, (_, i) => ({
              month: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][i],
              net: 1056,
            })),
          },
          {
            name: "Receptionist Tinashe",
            role: "Admin",
            salary: 900,
            photo: "male (1).jpg",
            department: "Admin",
            leave: 0,
            payroll: Array.from({ length: 12 }, (_, i) => ({
              month: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][i],
              net: 792,
            })),
          },
        ];

    saveStaff();
  }

  function saveStaff() {
    localStorage.setItem("smartdent_staff", JSON.stringify(staff));
  }

  // ============================
  // RENDER FUNCTIONS
  // ============================
  function renderPayrollSummary() {
    const ul = document.getElementById("payrollSummary");
    const totalStaff = staff.length;

    const totalPayroll = staff.reduce((sum, emp) => {
      const latest = emp.payroll?.slice(-1)[0];
      return sum + (latest?.net || 0);
    }, 0);

    const lastRun = staff[0]?.payroll?.slice(-1)[0]?.month || "—";

    ul.innerHTML = `
      <li class="flex justify-between"><span>Total Staff</span><span>${totalStaff}</span></li>
      <li class="flex justify-between"><span>Total Payroll</span><span>$${totalPayroll.toLocaleString()}</span></li>
      <li class="flex justify-between text-green-600"><span>Last Run</span><span>${lastRun}</span></li>
    `;
  }

  function renderStaff() {
    const ul = document.getElementById("staffList");
    ul.innerHTML = "";

    staff.forEach((emp, index) => {
      const li = document.createElement("li");
      li.className = "py-3 flex items-center justify-between";

      li.innerHTML = `
        <div class="flex items-center gap-3">
          <img src="${emp.photo}" class="w-10 h-10 rounded-full object-cover border" />
          <div>
            <div class="font-medium">${emp.name}</div>
            <div class="text-xs text-gray-500">${emp.role} • ${emp.department}</div>
            <div class="text-xs text-gray-500">Leave: ${emp.leave || 0} days</div>
            <button onclick="approveLeave(${index})" class="text-xs text-green-600 underline mt-1">Approve 1 Day Leave</button>
          </div>
        </div>
        <div class="text-right">
          <div class="text-sm">$${emp.salary.toLocaleString()}</div>
          <div class="text-xs text-gray-500">Net $${(emp.salary * 0.88).toFixed(2)}</div>
          <button onclick="generatePayslip(${index})" class="text-xs text-green-600 underline mt-1">Payslip</button>
        </div>
      `;
      ul.appendChild(li);
    });

    feather.replace();
  }
function getEmployeeColors() {
  const palette = [
    '#34D399', '#60A5FA', '#FBBF24', '#F87171',
    '#A78BFA', '#F472B6', '#10B981', '#F59E0B'
  ];
  return staff.map((_, i) => palette[i % palette.length]);
}

  function renderPayrollChart() {
  const ctx = document.getElementById('payrollChart').getContext('2d');

  // Destroy previous chart if it exists
  if (payrollChartInstance) {
    payrollChartInstance.destroy();
  }

  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const totals = months.map(month =>
    staff.reduce((sum, emp) => {
      const entry = emp.payroll?.find(p => p.month === month);
      return sum + (entry?.net || 0);
    }, 0)
  );

  payrollChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: months,
      datasets: [{
        label: 'Total Net Payroll',
        data: totals,
        backgroundColor: 'rgba(34,197,94,0.6)',
        borderColor: 'rgba(34,197,94,1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}
  function renderLeaveTracker() {
    const ul = document.getElementById("leaveTracker");
    ul.innerHTML = "";

    staff.forEach(emp => {
      const li = document.createElement("li");
      li.className = "flex justify-between";
      li.innerHTML = `<span>${emp.name}</span><span>${emp.leave || 0} days</span>`;
      ul.appendChild(li);
    });
  }

let leaveChartInstance = null;

function renderLeaveChart() {
  const ctx = document.getElementById('leaveChart').getContext('2d');
  const colors = getEmployeeColors();

  if (leaveChartInstance) {
    leaveChartInstance.destroy();
  }

  const labels = staff.map(emp => emp.name);
  const data = staff.map(emp => emp.leave || 0);

  leaveChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Leave Days',
        data,
        backgroundColor: colors,
        borderColor: colors,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  function renderLeaveKey(colors) {
  const container = document.getElementById('leaveKey');
  container.innerHTML = '';

  staff.forEach((emp, i) => {
    const item = document.createElement('div');
    item.className = 'flex items-center gap-2 text-sm mb-1';
    item.innerHTML = `
      <div class="w-4 h-4 rounded" style="background-color:${colors[i]}"></div>
      <span>${emp.name}</span>
    `;
    container.appendChild(item);
  });
}

  renderLeaveKey(colors);
}

  // ============================
  // PAYROLL ACTIONS
  // ============================
  function runPayroll() {
    const today = new Date();
    const month = today.toLocaleString("en-US", { month: "short" });

    staff.forEach(emp => {
      const net = emp.salary * 0.88;
      emp.payroll = emp.payroll || [];
      emp.payroll.push({ month, net });
    });

    saveStaff();
    renderPayrollSummary();
    renderPayrollChart();
  }

  function exportPayroll() {
    const { jsPDF } = window.jspdf;
    if (!jsPDF) return alert("jsPDF is not loaded. Please check your script tag.");

    const pdf = new jsPDF();
    pdf.setFontSize(16);
    pdf.text("SmartDent ERP — Payroll Summary", 15, 20);

    let y = 35;
    staff.forEach(emp => {
      const latest = emp.payroll?.slice(-1)[0];
      pdf.setFontSize(12);
      pdf.text(`${emp.name} (${emp.role})`, 15, y);
      pdf.text(`Net: $${latest?.net?.toFixed(2) || "0.00"}`, 150, y);
      y += 10;
    });

    pdf.save("SmartDent-Payroll-Summary.pdf");
  }

  // ============================
  // STAFF MODAL & ACTIONS
  // ============================
  function openStaffModal() {
    document.getElementById("staffModal").style.display = "flex";
  }

  function closeStaffModal() {
    document.getElementById("staffModal").style.display = "none";
  }

  document
    .querySelector('[data-feather="user-plus"]')
    ?.parentElement.addEventListener("click", openStaffModal);

  function addStaff() {
    const name = document.getElementById("staffName")?.value.trim();
    const role = document.getElementById("staffRole")?.value.trim();
    const salary = parseFloat(document.getElementById("staffSalary")?.value);
    const photo = document.getElementById("staffPhoto")?.value.trim();
    const department = document.getElementById("staffDept")?.value.trim();

    if (!name || !role || isNaN(salary) || !photo || !department) {
      alert("Please fill all fields correctly.");
      return;
    }

    staff.push({
      name,
      role,
      salary,
      photo,
      department,
      leave: 0,
      payroll: [{ month: "Oct", net: salary * 0.88 }],
    });

    saveStaff();
    closeStaffModal();
    renderStaff();
  }

  function approveLeave(index) {
    staff[index].leave += 1;
    saveStaff();
    renderStaff();
  }


async function generatePayslip(index) {
  const { jsPDF } = window.jspdf;
  const emp = staff[index];

  const pdf = new jsPDF({ unit: "mm", format: "a4" });

  // ====== LOAD FONTS ======
  // Load Poppins (normal)
  if (!window.fontsLoaded) {
    try {
      const poppinsRes = await fetch("https://cdn.jsdelivr.net/gh/google/fonts/ofl/poppins/Poppins-Regular.ttf");
      const poppinsBuffer = await poppinsRes.arrayBuffer();
      const poppinsBase64 = btoa(String.fromCharCode(...new Uint8Array(poppinsBuffer)));
      pdf.addFileToVFS("Poppins-Regular.ttf", poppinsBase64);
      pdf.addFont("Poppins-Regular.ttf", "Poppins", "normal");

      // Load Doksan for company name
      const doksanRes = await fetch("https://cdn.jsdelivr.net/gh/google/fonts/ofl/doksan/Doksan-Regular.ttf");
      const doksanBuffer = await doksanRes.arrayBuffer();
      const doksanBase64 = btoa(String.fromCharCode(...new Uint8Array(doksanBuffer)));
      pdf.addFileToVFS("Doksan-Regular.ttf", doksanBase64);
      pdf.addFont("Doksan-Regular.ttf", "Doksan", "normal");

      window.fontsLoaded = true;
    } catch (err) {
      console.warn("⚠️ Failed to load custom fonts, falling back to Helvetica.", err);
    }
  }


  // ====== INITIALIZE PDF ======
  const pdf = new jsPDF({ unit: "mm", format: "a4" });
  pdf.setFont(window.customFontLoaded ? "Poppins" : "helvetica", "normal");

  // ====== CONFIGURATION ======
  const emp = staff[index];
  const month = new Date().toLocaleString("en-US", { month: "long" });
  const year = new Date().getFullYear();
  const payrollPeriod = `${month} 01 – ${month} 31, ${year}`;
  const employeeId = "EMP-" + (index + 1).toString().padStart(4, "0");
  const logoUrl = "logo.jpeg";
  const themeColor = [34, 197, 94]; // SmartDent green

  // ====== PAY DATA ======
  const earnings = {
    Basic: emp.salary,
    Transport: 500,
    Food: 300,
    Housing: 800,
    Bonus: 200,
  };

  const deductions = {
    PAYE: emp.salary * 0.15,
    NAPSA: emp.salary * 0.05,
    NHIMA: emp.salary * 0.01,
    Loan: 250,
  };

  const totalEarnings = Object.values(earnings).reduce((a, b) => a + b, 0);
  const totalDeductions = Object.values(deductions).reduce((a, b) => a + b, 0);
  const netPay = totalEarnings - totalDeductions;

  const ytdEarnings = totalEarnings * 10;
  const ytdDeductions = totalDeductions * 10;

  // ====== LOAD LOGO ======
  const img = new Image();
  img.crossOrigin = "Anonymous";
  img.src = logoUrl;

  img.onload = () => {
 // ====== HEADER ======

// Set company name and payslip text first to measure width
pdf.setFont("Doksan", "normal");
pdf.setFontSize(16);
pdf.setTextColor(...themeColor);
const companyName = "SMAITDent Clinic";
const companyWidth = pdf.getTextWidth(companyName);

pdf.setFont("Poppins", "normal");
pdf.setFontSize(12);
const payslipText = "— Payslip —";
const payslipWidth = pdf.getTextWidth(payslipText);

// Position logo dynamically
const logoWidth = 25;   // adjust as needed
const logoHeight = 25;  // adjust as needed
const logoX = 15;       // left margin
const logoY = 10;

// Draw logo
pdf.addImage(img, "PNG", logoX, logoY, logoWidth, logoHeight);

// Company name (right of logo)
const textX = logoX + logoWidth + 5; // small gap between logo and text
const textY = logoY + 15;            // vertically aligned to logo
pdf.setFont("Doksan", "normal");
pdf.setFontSize(16);
pdf.setTextColor(...themeColor);
pdf.text(companyName, textX, textY);

// Payslip subtitle (centered under company name)
pdf.setFont("Poppins", "normal");
pdf.setFontSize(12);
pdf.setTextColor(0);
pdf.text(payslipText, textX, textY + 8);

// Payroll info
pdf.setFont("Poppins", "normal");
pdf.setFontSize(10);
pdf.setTextColor(0);
pdf.text(`Payroll Period: ${payrollPeriod}`, 15, logoY + logoHeight + 10);
pdf.text(`Employee ID: ${employeeId}`, 150, logoY + logoHeight + 10);


// ====== EMPLOYEE DETAILS (COMPACT ONE ROW) ======
pdf.setFontSize(8);
pdf.setTextColor(0);

// Labels
pdf.text("Name:", 15, 42);
pdf.text("Role:", 65, 42);
pdf.text("Dept:", 105, 42);
pdf.text("Date:", 150, 42);

// Values
pdf.setFont("Poppins", "normal");
pdf.text(emp.name, 28, 42);
pdf.text(emp.role, 77, 42);
pdf.text(emp.department, 118, 42);
pdf.text(new Date().toLocaleDateString(), 163, 42);


    // ====== TABLE HEADERS ======
    pdf.setFontSize(12);
    pdf.setFillColor(245, 245, 245);
    pdf.rect(15, 70, 180, 8, "F");
    pdf.text("EARNINGS", 25, 75);
    pdf.text("DEDUCTIONS", 120, 75);

    // ====== TABLE CONTENT ======
    let y = 83;
    pdf.setFontSize(11);

    const rows = Math.max(Object.keys(earnings).length, Object.keys(deductions).length);
    for (let i = 0; i < rows; i++) {
      const earnLabel = Object.keys(earnings)[i];
      const earnValue = Object.values(earnings)[i];
      const dedLabel = Object.keys(deductions)[i];
      const dedValue = Object.values(deductions)[i];

      if (earnLabel) pdf.text(earnLabel, 25, y);
      if (earnValue) pdf.text(`$${earnValue.toFixed(2)}`, 80, y, { align: "right" });

      if (dedLabel) pdf.text(dedLabel, 120, y);
      if (dedValue) pdf.text(`$${dedValue.toFixed(2)}`, 185, y, { align: "right" });

      y += 7;
    }

    // ====== TOTALS ======
    pdf.setDrawColor(...themeColor);
    pdf.line(15, y + 3, 195, y + 3);

    pdf.setFont("Poppins", "bold");
    pdf.text("Total Earnings:", 25, y + 10);
    pdf.text(`$${totalEarnings.toFixed(2)}`, 80, y + 10, { align: "right" });

    pdf.text("Total Deductions:", 120, y + 10);
    pdf.text(`$${totalDeductions.toFixed(2)}`, 185, y + 10, { align: "right" });

    // ====== NET PAY ======
    pdf.setFontSize(14);
    pdf.setTextColor(...themeColor);
    pdf.text("Net Pay:", 25, y + 22);
    pdf.text(`$${netPay.toFixed(2)}`, 80, y + 22, { align: "right" });

    // ====== YEAR-TO-DATE TABLE ======
    pdf.setFont("Poppins", "bold");
    pdf.setFontSize(11);
    pdf.setTextColor(0);
    pdf.text("Year-to-Date Summary", 15, y + 35);

    pdf.setFillColor(240, 240, 240);
    pdf.rect(15, y + 38, 180, 8, "F");
    pdf.setFontSize(10);
    pdf.text("Description", 20, y + 43);
    pdf.text("Amount (ZMW)", 100, y + 43);

    pdf.setFont("Poppins", "normal");
    pdf.setFillColor(255, 255, 255);
    pdf.rect(15, y + 46, 180, 7, "F");
    pdf.rect(15, y + 53, 180, 7, "F");

    pdf.text("YTD Earnings", 20, y + 51);
    pdf.text(`ZMW ${ytdEarnings.toFixed(2)}`, 100, y + 51);
    pdf.text("YTD Deductions", 20, y + 58);
    pdf.text(`ZMW ${ytdDeductions.toFixed(2)}`, 100, y + 58);

    pdf.setDrawColor(230, 230, 230);
    pdf.line(15, y + 63, 195, y + 63);

    // ====== QR CODE ======
    const qrCanvas = document.createElement("canvas");
    new QRious({
      element: qrCanvas,
      value: `https://smartdent.com/payslip/${employeeId}`,
      size: 100,
    });
    pdf.addImage(qrCanvas.toDataURL("image/png"), "PNG", 150, 210, 40, 40);

    // ====== SIGNATURE ======
    pdf.setFontSize(10);
    pdf.text("Authorized Signature: ___________________________", 15, 265);

    // ====== FOOTER ======
    pdf.setDrawColor(230, 57, 70);
    pdf.line(15, 270, 195, 270);
    pdf.setFontSize(10);
    pdf.setTextColor(100);
    pdf.text("SmartDent Clinic • +260 97 000 0000 • info@smartdent.com", 15, 275);

    // ====== SAVE ======
    pdf.save(`Payslip-${emp.name.replace(/\s+/g, "-")}.pdf`);
  };

  img.onerror = () => alert("❌ Failed to load logo image. Please check the file path.");
}


  // ============================
  // INIT
  // ============================
loadStaff();
renderStaff();
renderLeaveTracker();
renderPayrollSummary();
renderPayrollChart();
renderLeaveChart();
</script>
</body>
</html>
