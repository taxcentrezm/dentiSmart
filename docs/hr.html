<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartDent ERP — HR</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    .card { @apply bg-white rounded-2xl shadow p-4; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


</head>
<body class="bg-gray-50 font-sans text-gray-800 antialiased">

  <!-- Header -->
  <header class="bg-green-600 text-white py-4 shadow">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-white/90 flex items-center justify-center shadow">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3v6"></path><path d="M8 10s1 2 4 2 4-2 4-2"></path><path d="M6 21s2-4 6-4 6 4 6 4"></path>
          </svg>
        </div>
        <div class="font-semibold text-lg">SmartDent ERP</div>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="openStaffModal()" class="bg-white/90 text-green-600 px-3 py-2 rounded-md inline-flex items-center gap-2 shadow-sm">
  <i data-feather="user-plus"></i> Add Staff
</button>
        <div class="relative">
          <button class="flex items-center gap-2 bg-white/90 px-3 py-2 rounded-full shadow-sm">
            <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=100&auto=format&fit=crop" class="w-8 h-8 rounded-full object-cover">
            <span class="hidden md:inline-block text-sm">Dr. Phiri</span>
            <i data-feather="chevron-down"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
 <main class="container mx-auto px-4 py-6 space-y-6">
  <!-- Staff Directory -->
  <div class="card">
    <h2 class="text-xl font-semibold mb-4">Staff Directory</h2>
    <ul id="staffList" class="divide-y"></ul>
  </div>

  <!-- Payroll & Leave -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Payroll Summary -->
    <div class="card">
      <h3 class="font-semibold mb-3">Payroll Summary</h3>
      <ul id="payrollSummary" class="space-y-2 text-sm"></ul>
      <div class="mt-4 flex gap-2">
        <button onclick="runPayroll()" class="flex-1 px-4 py-2 rounded-md bg-green-600 text-white">Run Payroll</button>
        <button onclick="exportPayroll()" class="px-4 py-2 rounded-md border">Export</button>
      </div>
      <div class="card">
  <h3 class="font-semibold mb-3">Payroll History Chart</h3>
  <canvas id="payrollChart" height="200"></canvas>
</div>
    </div>
    

    <!-- Leave Tracker -->
    <div class="card">
      <h3 class="font-semibold mb-3">Leave Tracker</h3>
      <ul id="leaveTracker" class="space-y-2 text-sm"></ul>
    </div>
  </div>
   <div class="card">
  <h3 class="font-semibold mb-3">Leave Tracker</h3>
  <ul id="leaveTracker" class="space-y-2 text-sm"></ul>
  <canvas id="leaveChart" height="200" class="mt-6"></canvas>
</div>


  <!-- Add Staff Modal -->
  <div id="staffModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
      <h3 class="text-lg font-semibold mb-4">Add New Staff</h3>
      <div class="space-y-3">
        <input id="staffName" type="text" placeholder="Full Name" class="w-full px-3 py-2 border rounded-md" />
        <input id="staffRole" type="text" placeholder="Role" class="w-full px-3 py-2 border rounded-md" />
        <input id="staffSalary" type="number" placeholder="Salary" class="w-full px-3 py-2 border rounded-md" />
        <input id="staffPhoto" type="text" placeholder="Photo URL" class="w-full px-3 py-2 border rounded-md" />
        <input id="staffDept" type="text" placeholder="Department" class="w-full px-3 py-2 border rounded-md" />
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button onclick="closeStaffModal()" class="px-4 py-2 border rounded-md">Cancel</button>
        <button onclick="addStaff()" class="px-4 py-2 bg-green-600 text-white rounded-md">Add</button>
      </div>
    </div>
  </div>
</main>

  <footer class="mt-8 text-sm text-gray-500 text-center">
    SmartDent ERP • Human Resources & Payroll
  </footer>
  <script src="core.js"></script>
  <!-- Scripts -->
<script>
  feather.replace();
let payrollChartInstance = null;
  let staff = [];

  // ============================
  // LOAD / SAVE STAFF DATA
  // ============================
  function loadStaff() {
    const stored = localStorage.getItem("smartdent_staff");
    staff = stored
      ? JSON.parse(stored)
      : [
          {
            name: "Dr. Alice Mwansa",
            role: "Dentist",
            salary: 5000,
            photo: "female (2).jpg",
            department: "Dental",
            leave: 2,
            payroll: Array.from({ length: 12 }, (_, i) => ({
              month: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][i],
              net: 4400,
            })),
          },
          {
            name: "Dr. Brian Zulu",
            role: "Orthodontist",
            salary: 6200,
            photo: "male (2).jpg",
            department: "Ortho",
            leave: 1,
            payroll: Array.from({ length: 12 }, (_, i) => ({
              month: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][i],
              net: 5456,
            })),
          },
          {
            name: "Nurse Chipo",
            role: "Dental Nurse",
            salary: 1200,
            photo: "female (1).jpg",
            department: "Support",
            leave: 1,
            payroll: Array.from({ length: 12 }, (_, i) => ({
              month: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][i],
              net: 1056,
            })),
          },
          {
            name: "Receptionist Tinashe",
            role: "Admin",
            salary: 900,
            photo: "male (1).jpg",
            department: "Admin",
            leave: 0,
            payroll: Array.from({ length: 12 }, (_, i) => ({
              month: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][i],
              net: 792,
            })),
          },
        ];

    saveStaff();
  }

  function saveStaff() {
    localStorage.setItem("smartdent_staff", JSON.stringify(staff));
  }

  // ============================
  // RENDER FUNCTIONS
  // ============================
  function renderPayrollSummary() {
    const ul = document.getElementById("payrollSummary");
    const totalStaff = staff.length;

    const totalPayroll = staff.reduce((sum, emp) => {
      const latest = emp.payroll?.slice(-1)[0];
      return sum + (latest?.net || 0);
    }, 0);

    const lastRun = staff[0]?.payroll?.slice(-1)[0]?.month || "—";

    ul.innerHTML = `
      <li class="flex justify-between"><span>Total Staff</span><span>${totalStaff}</span></li>
      <li class="flex justify-between"><span>Total Payroll</span><span>$${totalPayroll.toLocaleString()}</span></li>
      <li class="flex justify-between text-green-600"><span>Last Run</span><span>${lastRun}</span></li>
    `;
  }

  function renderStaff() {
    const ul = document.getElementById("staffList");
    ul.innerHTML = "";

    staff.forEach((emp, index) => {
      const li = document.createElement("li");
      li.className = "py-3 flex items-center justify-between";

      li.innerHTML = `
        <div class="flex items-center gap-3">
          <img src="${emp.photo}" class="w-10 h-10 rounded-full object-cover border" />
          <div>
            <div class="font-medium">${emp.name}</div>
            <div class="text-xs text-gray-500">${emp.role} • ${emp.department}</div>
            <div class="text-xs text-gray-500">Leave: ${emp.leave || 0} days</div>
            <button onclick="approveLeave(${index})" class="text-xs text-green-600 underline mt-1">Approve 1 Day Leave</button>
          </div>
        </div>
        <div class="text-right">
          <div class="text-sm">$${emp.salary.toLocaleString()}</div>
          <div class="text-xs text-gray-500">Net $${(emp.salary * 0.88).toFixed(2)}</div>
          <button onclick="generatePayslip(${index})" class="text-xs text-green-600 underline mt-1">Payslip</button>
        </div>
      `;
      ul.appendChild(li);
    });

    feather.replace();
  }

  function renderPayrollChart() {
  const ctx = document.getElementById('payrollChart').getContext('2d');

  // Destroy previous chart if it exists
  if (payrollChartInstance) {
    payrollChartInstance.destroy();
  }

  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const totals = months.map(month =>
    staff.reduce((sum, emp) => {
      const entry = emp.payroll?.find(p => p.month === month);
      return sum + (entry?.net || 0);
    }, 0)
  );

  payrollChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: months,
      datasets: [{
        label: 'Total Net Payroll',
        data: totals,
        backgroundColor: 'rgba(34,197,94,0.6)',
        borderColor: 'rgba(34,197,94,1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}
  function renderLeaveTracker() {
    const ul = document.getElementById("leaveTracker");
    ul.innerHTML = "";

    staff.forEach(emp => {
      const li = document.createElement("li");
      li.className = "flex justify-between";
      li.innerHTML = `<span>${emp.name}</span><span>${emp.leave || 0} days</span>`;
      ul.appendChild(li);
    });
  }

  // ============================
  // PAYROLL ACTIONS
  // ============================
  function runPayroll() {
    const today = new Date();
    const month = today.toLocaleString("en-US", { month: "short" });

    staff.forEach(emp => {
      const net = emp.salary * 0.88;
      emp.payroll = emp.payroll || [];
      emp.payroll.push({ month, net });
    });

    saveStaff();
    renderPayrollSummary();
    renderPayrollChart();
  }

  function exportPayroll() {
    const { jsPDF } = window.jspdf;
    if (!jsPDF) return alert("jsPDF is not loaded. Please check your script tag.");

    const pdf = new jsPDF();
    pdf.setFontSize(16);
    pdf.text("SmartDent ERP — Payroll Summary", 15, 20);

    let y = 35;
    staff.forEach(emp => {
      const latest = emp.payroll?.slice(-1)[0];
      pdf.setFontSize(12);
      pdf.text(`${emp.name} (${emp.role})`, 15, y);
      pdf.text(`Net: $${latest?.net?.toFixed(2) || "0.00"}`, 150, y);
      y += 10;
    });

    pdf.save("SmartDent-Payroll-Summary.pdf");
  }

  // ============================
  // STAFF MODAL & ACTIONS
  // ============================
  function openStaffModal() {
    document.getElementById("staffModal").style.display = "flex";
  }

  function closeStaffModal() {
    document.getElementById("staffModal").style.display = "none";
  }

  document
    .querySelector('[data-feather="user-plus"]')
    ?.parentElement.addEventListener("click", openStaffModal);

  function addStaff() {
    const name = document.getElementById("staffName")?.value.trim();
    const role = document.getElementById("staffRole")?.value.trim();
    const salary = parseFloat(document.getElementById("staffSalary")?.value);
    const photo = document.getElementById("staffPhoto")?.value.trim();
    const department = document.getElementById("staffDept")?.value.trim();

    if (!name || !role || isNaN(salary) || !photo || !department) {
      alert("Please fill all fields correctly.");
      return;
    }

    staff.push({
      name,
      role,
      salary,
      photo,
      department,
      leave: 0,
      payroll: [{ month: "Oct", net: salary * 0.88 }],
    });

    saveStaff();
    closeStaffModal();
    renderStaff();
  }

  function approveLeave(index) {
    staff[index].leave += 1;
    saveStaff();
    renderStaff();
  }

  function generatePayslip(index) {
  const { jsPDF } = window.jspdf;
  const emp = staff[index];
  const pdf = new jsPDF();

  // Sample values (replace with real logic or stored values)
  const payrollPeriod = 'Oct 01 – Oct 31, 2025';
  const taxWeek = 'Week 40';
  const employeeId = 'EMP-' + (index + 1).toString().padStart(4, '0');

  const earnings = {
    basic: emp.salary,
    transport: 500,
    food: 300,
    housing: 800,
    bonus: 200
  };

  const deductions = {
    paye: emp.salary * 0.15,
    napsa: emp.salary * 0.05,
    nimha: emp.salary * 0.01,
    loan: 250
  };

  const totalEarnings = Object.values(earnings).reduce((a, b) => a + b, 0);
  const totalDeductions = Object.values(deductions).reduce((a, b) => a + b, 0);
  const netPay = totalEarnings - totalDeductions;

  const ytdEarnings = totalEarnings * 10; // example
  const ytdDeductions = totalDeductions * 10;

  // Header
  pdf.setFontSize(16);
  pdf.text('SmartDent ERP — Payslip', 15, 20);
  pdf.setFontSize(10);
  pdf.text(`Payroll Period: ${payrollPeriod}`, 15, 28);
  pdf.text(`Tax Week: ${taxWeek}`, 150, 28);

  // Employee Info
  pdf.setFontSize(12);
  pdf.text(`Name: ${emp.name}`, 15, 38);
  pdf.text(`Role: ${emp.role}`, 15, 45);
  pdf.text(`Department: ${emp.department}`, 15, 52);
  pdf.text(`Employee ID: ${employeeId}`, 15, 59);

  // Earnings Table
  pdf.setFontSize(12);
  pdf.text('Earnings', 15, 70);
  let y = 75;
  Object.entries(earnings).forEach(([label, value]) => {
    pdf.text(label.charAt(0).toUpperCase() + label.slice(1), 20, y);
    pdf.text(`$${value.toFixed(2)}`, 100, y);
    y += 7;
  });

  // Deductions Table
  pdf.text('Deductions', 15, y + 5);
  y += 10;
  Object.entries(deductions).forEach(([label, value]) => {
    pdf.text(label.toUpperCase(), 20, y);
    pdf.text(`$${value.toFixed(2)}`, 100, y);
    y += 7;
  });

  // Net Pay
  pdf.setFontSize(12);
  pdf.text('Net Pay:', 20, y + 10);
  pdf.text(`$${netPay.toFixed(2)}`, 100, y + 10);

  // YTD Summary
  pdf.setFontSize(12);
  pdf.text('Year-to-Date Summary', 15, y + 25);
  pdf.setFontSize(10);
  pdf.text(`YTD Earnings: $${ytdEarnings.toFixed(2)}`, 20, y + 32);
  pdf.text(`YTD Deductions: $${ytdDeductions.toFixed(2)}`, 20, y + 39);

  // Footer
  pdf.setDrawColor(230, 57, 70);
  pdf.line(15, 270, 195, 270);
  pdf.setFontSize(10);
  pdf.setTextColor(100);
  pdf.text('SmartDent Clinic • +260 97 000 0000 • info@smartdent.com', 15, 275);
  pdf.text('Authorized Signature: ___________________________', 15, 265);

  pdf.save(`Payslip-${emp.name.replace(/\s+/g, '-')}.pdf`);
}


  // ============================
  // INIT
  // ============================
loadStaff();
renderStaff();
renderLeaveTracker();
renderPayrollSummary();
renderPayrollChart();
renderLeaveChart();
</script>
</body>
</html>
